<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Familietid</title>
  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f172a;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 24px 60px rgba(0,0,0,.35);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 500px at 40% 90%, rgba(236,72,153,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding:14px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius: calc(var(--r) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 18px;
      border-bottom:1px solid var(--border);
    }
    .topL{display:flex; gap:14px; align-items:center}
    .avatar{
      width:52px;height:52px;border-radius:16px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      font-size:26px;
    }
    .h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px}
    .sub{margin:2px 0 0 0;color:var(--muted);font-size:12px;font-weight:700}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900; font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%;}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.primary{background: rgba(99,102,241,.22); border-color: rgba(99,102,241,.35)}
    .btn.good{background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.35)}
    .btn.small{padding:10px 12px;border-radius:12px}
    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }
    .tab{
      flex:1; min-width:140px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
      display:flex; gap:10px; align-items:center; justify-content:center;
    }
    .tab.active{background: rgba(99,102,241,.25); border-color: rgba(99,102,241,.35)}
    .content{padding:16px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    @media (max-width:860px){ .grid2,.grid3{grid-template-columns:1fr} }

    .panel{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    .title{font-weight:950;margin:0 0 10px 0;letter-spacing:.2px}
    .muted{color:var(--muted);font-weight:700}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field, select{
      width:100%;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
      font-size:15px;
      font-weight:800;
    }
    .field:focus, select:focus{border-color: rgba(99,102,241,.55)}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .item{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .itL{min-width:0}
    .itT{font-weight:950}
    .itM{margin-top:4px; font-size:12px; color:var(--muted); font-weight:750}
    .itR{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-size:12px; font-weight:900;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .chip{padding:8px 12px}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .toast{
      position:fixed; top:14px; left:50%; transform:translateX(-50%);
      max-width:min(900px,92vw);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      font-weight:900;
      display:flex; gap:10px; align-items:center;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0)}
    .toast.good{border-color: rgba(34,197,94,.35)}
    .toast.bad{border-color: rgba(239,68,68,.35)}
    .toast.warn{border-color: rgba(245,158,11,.40)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ============================================================
   SUPABASE (prefylt)
   ============================================================ */
const SUPABASE_URL = "https://tifhelbmaqoojqtqhzso.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpZmhlbGJtYXFvb2pxdHFoenNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODY5NTYsImV4cCI6MjA4NDA2Mjk1Nn0.WFMmeOZvEYL9AAoLRHFVx97b8hT9Z2us-iWAxAjv9Fg";

/* ============================================================
   USERS (enkel ‚Äúrolle‚Äù-styring uten auth)
   ============================================================ */
const USERS = [
  { name:"Emmie",   emoji:"üå∏", color:"#ff6b9d", role:"child"  },
  { name:"Thelma",  emoji:"ü¶ã", color:"#c471ed", role:"child"  },
  { name:"Elea",    emoji:"üåü", color:"#f9ca24", role:"child"  },
  { name:"Katrine", emoji:"üå∫", color:"#ff7979", role:"parent" },
  { name:"Kim Rune",emoji:"‚ö°", color:"#4a90e2", role:"parent" },
];

const LS_USER = "familietid_user_v2";

/* ============================================================
   STATE
   ============================================================ */
const state = {
  user: null,
  tab: "shopping",
  loading: false,
  data: {
    shopping: [],
    choresTasks: [],
    choresWorkers: [],
    weekly: [],
  },
  ui: {
    weekKey: "auto", // auto => current week if exists else latest
  }
};

const appEl = document.getElementById("app");
const toastEl = document.getElementById("toast");

/* ============================================================
   UTIL
   ============================================================ */
function toast(msg, type="good"){
  const icon = type==="good"?"‚úÖ":type==="bad"?"‚ùå":"‚ö†Ô∏è";
  toastEl.className = `toast show ${type}`;
  toastEl.innerHTML = `<span>${icon}</span><span>${escapeHtml(msg)}</span>`;
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>{ toastEl.className="toast"; }, 2600);
}
function escapeHtml(s){
  return (s ?? "").toString().replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function isoDate(d=new Date()){ return new Date(d).toISOString(); }
function nowISO(){ return new Date().toISOString(); }
function fmtShort(iso){
  if(!iso) return "";
  return new Date(iso).toLocaleString("no-NO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});
}
function currentISOWeekKey(){
  // ISO week key: YYYY-Www
  const d = new Date();
  const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNr = (target.getUTCDay() + 6) % 7;
  target.setUTCDate(target.getUTCDate() - dayNr + 3);
  const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
  const diff = target - firstThursday;
  const week = 1 + Math.round(diff / 604800000);
  const year = target.getUTCFullYear();
  return `${year}-W${String(week).padStart(2,"0")}`;
}
function weekKeyFromRow(r){ return `${r.year}-W${String(r.week).padStart(2,"0")}`; }

/* ============================================================
   SUPABASE REST HELPERS
   ============================================================ */
async function sb(path, { method="GET", body=null, headers={} }={}){
  const url = `${SUPABASE_URL}/rest/v1/${path}`;
  const res = await fetch(url, {
    method,
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json",
      "Prefer": "return=representation",
      ...headers
    },
    body: body ? JSON.stringify(body) : null
  });
  const text = await res.text();
  const data = text ? JSON.parse(text) : null;
  if(!res.ok){
    throw new Error((data && (data.message || data.error_description)) || text || `HTTP ${res.status}`);
  }
  return data;
}
function q(s){ return encodeURIComponent(s); }

/* ============================================================
   LOADERS
   ============================================================ */
async function loadShopping(){
  return await sb(`shopping_items?select=*&order=timestamp.desc`);
}
async function loadChores(){
  const [tasks, workers, weekly] = await Promise.all([
    sb(`chore_tasks?select=*&order=created_at.desc`),
    sb(`chore_workers?select=*&order=started_at.desc`),
    // view (du har opprettet weekly_earnings)
    sb(`weekly_earnings?select=*&order=year.desc,week.desc,worker_name.asc`)
      .catch(()=>[]) // hvis viewen mangler, fail-safe
  ]);
  return { tasks, workers, weekly };
}

/* ============================================================
   SHOPPING ACTIONS
   ============================================================ */
async function addShopping(text, qty){
  if(!text.trim()) return toast("Skriv inn en vare f√∏rst", "warn");
  const row = {
    text: text.trim(),
    quantity: Number(qty)||1,
    checked: false,
    added_by: state.user.name,
    added_by_color: state.user.color,
    timestamp: nowISO()
  };
  await sb(`shopping_items`, { method:"POST", body: row });
  toast("Lagt til!", "good");
  await refresh();
}
async function toggleShopping(item){
  await sb(`shopping_items?id=eq.${item.id}`, {
    method:"PATCH",
    body: { checked: !item.checked }
  });
  await refresh(false);
}
async function deleteShopping(item){
  await sb(`shopping_items?id=eq.${item.id}`, { method:"DELETE", headers: {"Prefer":"return=minimal"} });
  toast("Slettet", "warn");
  await refresh();
}

/* ============================================================
   CHORES / UKEL√òNN ACTIONS
   ============================================================ */
function isParent(){ return state.user?.role === "parent"; }
function isChild(){ return state.user?.role === "child"; }

async function createFamilyTask({title, amount, category, task_type}){
  if(!isParent()) return toast("Kun foreldre kan opprette familieoppgaver", "warn");
  if(!title.trim()) return toast("Oppgavetittel mangler", "warn");
  const row = {
    title: title.trim(),
    description: null,
    amount: Number(amount)||0,
    task_type: task_type || "once",
    category: category || "hjemme",
    status: "available",
    created_by: state.user.name,
    created_by_color: state.user.color,
    proposed_by_child: false,
    created_at: nowISO()
  };
  await sb(`chore_tasks`, { method:"POST", body: row });
  toast("Oppgave opprettet", "good");
  await refresh();
}

async function proposeTask({title, amount, category}){
  if(!isChild()) return toast("Kun barn kan foresl√• oppgaver her", "warn");
  if(!title.trim()) return toast("Oppgavetittel mangler", "warn");
  const row = {
    title: title.trim(),
    description: "Foresl√•tt av barn",
    amount: Number(amount)||0,
    task_type: "once",
    category: category || "hjemme",
    status: "proposed",
    created_by: state.user.name,
    created_by_color: state.user.color,
    proposed_by_child: true,
    created_at: nowISO()
  };
  await sb(`chore_tasks`, { method:"POST", body: row });
  toast("Forslag sendt til godkjenning", "good");
  await refresh();
}

async function approveProposal(task){
  if(!isParent()) return toast("Kun foreldre kan godkjenne forslag", "warn");
  await sb(`chore_tasks?id=eq.${task.id}`, {
    method:"PATCH",
    body: { status:"available", approved_by: state.user.name, approved_at: nowISO() }
  });
  toast("Forslag godkjent", "good");
  await refresh();
}
async function rejectProposal(task){
  if(!isParent()) return toast("Kun foreldre kan avvise forslag", "warn");
  await sb(`chore_tasks?id=eq.${task.id}`, {
    method:"PATCH",
    body: { status:"rejected", approved_by: state.user.name, approved_at: nowISO() }
  });
  toast("Forslag avvist", "warn");
  await refresh();
}

async function takeTask(task){
  if(!isChild()) return toast("Kun barn kan ta oppgaver", "warn");
  // Lag worker-rad
  const worker = {
    task_id: task.id,
    worker_name: state.user.name,
    worker_color: state.user.color,
    percentage: 100,
    confirmed: true,
    started_at: nowISO()
  };
  await sb(`chore_workers`, { method:"POST", body: worker });
  // Oppdater status p√• task (valgfritt men ryddig)
  await sb(`chore_tasks?id=eq.${task.id}`, { method:"PATCH", body: { status:"assigned" } });
  toast("Oppgave tatt", "good");
  await refresh();
}

async function completeMyWork(worker){
  if(!isChild()) return toast("Kun barn kan fullf√∏re", "warn");
  if(worker.worker_name !== state.user.name) return toast("Dette er ikke din oppgave", "warn");
  await sb(`chore_workers?id=eq.${worker.id}`, { method:"PATCH", body: { completed_at: nowISO() } });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"completed" } });
  toast("Fullf√∏rt ‚Äì venter p√• godkjenning", "warn");
  await refresh();
}

async function approveWork(worker){
  if(!isParent()) return toast("Kun foreldre kan godkjenne", "warn");
  // Finn task (for bel√∏p)
  const task = state.data.choresTasks.find(t => t.id === worker.task_id);
  if(!task) return toast("Fant ikke oppgaven", "bad");
  const earned = Math.round((task.amount || 0) * ((worker.percentage||100)/100));
  await sb(`chore_workers?id=eq.${worker.id}`, {
    method:"PATCH",
    body: { approved_at: nowISO(), approved_by: state.user.name, earned_amount: earned }
  });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"approved" } });
  toast("Godkjent ‚úÖ", "good");
  await refresh();
}

async function rejectWork(worker){
  if(!isParent()) return toast("Kun foreldre kan avvise", "warn");
  await sb(`chore_workers?id=eq.${worker.id}`, {
    method:"PATCH",
    body: { rejected_at: nowISO(), rejected_by: state.user.name }
  });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"available" } });
  toast("Avvist ‚Äì tilbake til tilgjengelig", "warn");
  await refresh();
}

/* ============================================================
   RENDER
   ============================================================ */
function render(){
  if(!state.user){
    appEl.innerHTML = `
      <div class="top">
        <div class="topL">
          <div class="avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <div>
            <p class="h1">Familietid</p>
            <p class="sub">Velg bruker</p>
          </div>
        </div>
        <span class="pill"><span class="dot" style="background:${state.loading? "var(--warn)":"var(--good)"}"></span>${state.loading?"Laster‚Ä¶":"Klar"}</span>
      </div>
      <div class="content">
        <div class="grid2">
          ${USERS.map(u=>`
            <button class="btn" onclick="selectUser('${u.name}')"
              style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:18px;">
              <span style="display:flex;gap:12px;align-items:center">
                <span style="width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);font-size:20px">${u.emoji}</span>
                <span style="text-align:left">
                  <div style="font-weight:950">${escapeHtml(u.name)}</div>
                  <div class="muted" style="font-size:12px">${u.role==="parent"?"Forelder":"Barn"}</div>
                </span>
              </span>
              <span class="chip" style="border-color:${u.color}55">${u.color}</span>
            </button>
          `).join("")}
        </div>
      </div>
    `;
    return;
  }

  const tab = state.tab;
  const tabButtons = [
    { id:"shopping", label:"Handleliste", icon:"üõí" },
    { id:"allowance", label:"Ukel√∏nn", icon:"üí∞" },
  ];

  appEl.innerHTML = `
    <div class="top">
      <div class="topL">
        <div class="avatar" style="border-color:${state.user.color}55">${state.user.emoji}</div>
        <div>
          <p class="h1">Hei, ${escapeHtml(state.user.name)}!</p>
          <p class="sub">${state.user.role==="parent"?"Forelder":"Barn"} ‚Ä¢ Familietid</p>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <span class="pill"><span class="dot" style="background:${state.loading? "var(--warn)":"var(--good)"}"></span>${state.loading?"Laster‚Ä¶":"Online"}</span>
        <button class="btn small" onclick="refresh()">Oppdater</button>
        <button class="btn small" onclick="logout()">Bytt bruker</button>
      </div>
    </div>

    <div class="tabs">
      ${tabButtons.map(t=>`
        <button class="tab ${tab===t.id?"active":""}" onclick="switchTab('${t.id}')">${t.icon} ${t.label}</button>
      `).join("")}
    </div>

    <div class="content">
      ${tab==="shopping" ? renderShopping() : ""}
      ${tab==="allowance" ? renderAllowance() : ""}
    </div>
  `;
}

/* ============================================================
   SHOPPING UI
   ============================================================ */
function renderShopping(){
  const items = state.data.shopping;
  return `
    <div class="panel">
      <p class="title">üõí Handleliste</p>
      <div class="row">
        <input class="field" id="shopText" placeholder="Hva skal kj√∏pes?" />
        <input class="field" id="shopQty" type="number" min="1" value="1" style="max-width:120px" />
        <button class="btn primary" onclick="uiAddShopping()">Legg til</button>
      </div>

      <div class="list">
        ${items.length===0 ? `<div class="muted">Ingen varer enda.</div>` : items.map(i=>`
          <div class="item">
            <div class="itL">
              <div class="itT">${i.checked ? "‚úÖ " : ""}${escapeHtml(i.text)} <span class="muted">x${i.quantity||1}</span></div>
              <div class="itM">
                <span style="color:${escapeHtml(i.added_by_color)};font-weight:950">${escapeHtml(i.added_by)}</span>
                ‚Ä¢ ${fmtShort(i.timestamp)}
              </div>
            </div>
            <div class="itR">
              <button class="btn small ${i.checked?"good":"primary"}" onclick='toggleShopping(${JSON.stringify(i)})'>${i.checked?"Ukj√∏pt":"Kj√∏pt"}</button>
              <button class="btn small bad" onclick='deleteShopping(${JSON.stringify(i)})'>Slett</button>
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `;
}
function uiAddShopping(){
  const text = document.getElementById("shopText").value;
  const qty = document.getElementById("shopQty").value;
  addShopping(text, qty).catch(e=>toast("Kunne ikke legge til: " + e.message, "bad"));
  document.getElementById("shopText").value="";
  document.getElementById("shopQty").value="1";
}

/* ============================================================
   ALLOWANCE UI (barn forslag + velg oppgaver + ukestatistikk)
   ============================================================ */
function renderAllowance(){
  const user = state.user;
  const tasks = state.data.choresTasks;
  const workers = state.data.choresWorkers;
  const weekly = state.data.weekly;

  const proposed = tasks.filter(t => t.status==="proposed" && t.proposed_by_child===true);
  const available = tasks.filter(t => t.status==="available");
  const assigned = tasks.filter(t => t.status==="assigned");
  const completedWorkers = workers.filter(w => w.completed_at && !w.approved_at && !w.rejected_at);
  const myWorkers = workers.filter(w => w.worker_name===user.name && !w.rejected_at);
  const myActive = myWorkers.filter(w => !w.completed_at && !w.approved_at);
  const myDoneWaiting = myWorkers.filter(w => w.completed_at && !w.approved_at);

  // Week picker
  const weekKeys = Array.from(new Set(weekly.map(weekKeyFromRow)));
  const currentKey = currentISOWeekKey();
  let selectedKey = state.ui.weekKey;
  if(selectedKey==="auto"){
    selectedKey = weekKeys.includes(currentKey) ? currentKey : (weekKeys[0] || currentKey);
  }
  const selRows = weekly.filter(r => weekKeyFromRow(r)===selectedKey);
  const children = USERS.filter(u=>u.role==="child");

  return `
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <p class="title">üí∞ Ukel√∏nn</p>
          <div class="muted">Forslag ‚Üí Godkjent forslag ‚Üí Barn tar ‚Üí Fullf√∏rer ‚Üí Forelder godkjenner ‚Üí Teller i uke-statistikk</div>
        </div>
        <div style="min-width:220px">
          <div class="muted" style="margin-bottom:6px">Uke</div>
          <select onchange="setWeek(this.value)">
            <option value="auto" ${state.ui.weekKey==="auto"?"selected":""}>Auto (n√• / siste)</option>
            ${weekKeys.map(k=>`<option value="${k}" ${state.ui.weekKey===k?"selected":""}>${k}</option>`).join("")}
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid3">
        ${children.map(c=>{
          const r = selRows.find(x=>x.worker_name===c.name);
          const sum = r ? r.sum_earned : 0;
          const cnt = r ? r.approved_tasks : 0;
          return `
            <div class="panel" style="background:rgba(255,255,255,.04)">
              <div class="row" style="justify-content:space-between">
                <div class="row" style="gap:10px">
                  <div class="avatar" style="width:44px;height:44px;border-radius:14px;border-color:${c.color}55">${c.emoji}</div>
                  <div>
                    <div style="font-weight:950">${escapeHtml(c.name)}</div>
                    <div class="muted" style="font-size:12px">${selectedKey}</div>
                  </div>
                </div>
                <div class="chip" style="border-color:${c.color}55">${sum} kr</div>
              </div>
              <div class="kpi" style="margin-top:10px">
                <span class="chip">Godkjent: ${cnt}</span>
                <span class="chip">Sum: ${sum} kr</span>
              </div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="hr"></div>

      ${isChild() ? renderAllowanceChild({available, myActive, myDoneWaiting}) : ""}
      ${isParent() ? renderAllowanceParent({proposed, available, assigned, completedWorkers, tasks, workers}) : ""}
    </div>
  `;
}

function renderAllowanceChild({available, myActive, myDoneWaiting}){
  return `
    <div class="grid2">
      <div class="panel">
        <p class="title">‚úÖ Tilgjengelige oppgaver</p>
        <div class="muted">Velg blant familieoppgaver (inkl. godkjente forslag)</div>

        <div class="list">
          ${available.length===0 ? `<div class="muted">Ingen tilgjengelige oppgaver akkurat n√•.</div>` : available.slice(0,50).map(t=>`
            <div class="item" style="border-left:6px solid ${escapeHtml(t.created_by_color)}">
              <div class="itL">
                <div class="itT">${escapeHtml(t.title)} <span class="muted">(${t.amount} kr)</span></div>
                <div class="itM">Laget av <span style="color:${escapeHtml(t.created_by_color)};font-weight:950">${escapeHtml(t.created_by)}</span> ‚Ä¢ ${escapeHtml(t.category || "hjemme")}</div>
              </div>
              <div class="itR">
                <button class="btn small primary" onclick='takeTask(${JSON.stringify(t)}).catch(e=>toast("Kunne ikke ta oppgave: "+e.message,"bad"))'>Ta</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="panel">
        <p class="title">üß† Foresl√• oppgave</p>
        <div class="muted">Barna kan foresl√• ‚Äì foreldre godkjenner f√∏r den blir tilgjengelig.</div>
        <div class="hr"></div>
        <div class="row">
          <input class="field" id="pTitle" placeholder="Oppgavetittel (f.eks. Rydde rommet)" />
          <input class="field" id="pAmount" type="number" min="0" placeholder="Bel√∏p (kr)" style="max-width:160px" />
          <select id="pCat" style="max-width:220px">
            <option value="hjemme">Hjemme</option>
            <option value="ute">Ute</option>
            <option value="annet">Annet</option>
          </select>
          <button class="btn primary" onclick="uiProposeTask()">Send forslag</button>
        </div>

        <div class="hr"></div>

        <p class="title">‚è≥ Mine oppgaver</p>
        <div class="list">
          ${myActive.length===0 ? `<div class="muted">Ingen aktive oppgaver.</div>` : myActive.map(w=>`
            <div class="item">
              <div class="itL">
                <div class="itT">Oppgave #${w.task_id}</div>
                <div class="itM">Startet: ${fmtShort(w.started_at)}</div>
              </div>
              <div class="itR">
                <button class="btn small warn" onclick='completeMyWork(${JSON.stringify(w)}).catch(e=>toast("Kunne ikke fullf√∏re: "+e.message,"bad"))'>Fullf√∏rt</button>
              </div>
            </div>
          `).join("")}

          ${myDoneWaiting.length===0 ? `` : `
            <div class="muted">Venter p√• godkjenning:</div>
            ${myDoneWaiting.map(w=>`
              <div class="item">
                <div class="itL">
                  <div class="itT">Oppgave #${w.task_id}</div>
                  <div class="itM">Fullf√∏rt: ${fmtShort(w.completed_at)}</div>
                </div>
                <div class="itR"><span class="chip">Venter</span></div>
              </div>
            `).join("")}
          `}
        </div>
      </div>
    </div>
  `;
}
function uiProposeTask(){
  const title = document.getElementById("pTitle").value;
  const amount = document.getElementById("pAmount").value;
  const category = document.getElementById("pCat").value;
  proposeTask({title, amount, category}).catch(e=>toast("Kunne ikke foresl√•: "+e.message,"bad"));
  document.getElementById("pTitle").value="";
  document.getElementById("pAmount").value="";
}

function renderAllowanceParent({proposed, available, assigned, completedWorkers, tasks, workers}){
  return `
    <div class="grid2">
      <div class="panel">
        <p class="title">üßæ Forslag fra barn</p>
        <div class="muted">Oppgaver med status <code>proposed</code></div>

        <div class="list">
          ${proposed.length===0 ? `<div class="muted">Ingen forslag akkurat n√•.</div>` : proposed.map(t=>`
            <div class="item" style="border-left:6px solid ${escapeHtml(t.created_by_color)}">
              <div class="itL">
                <div class="itT">${escapeHtml(t.title)} <span class="muted">(${t.amount} kr)</span></div>
                <div class="itM">Foresl√•tt av <span style="color:${escapeHtml(t.created_by_color)};font-weight:950">${escapeHtml(t.created_by)}</span></div>
              </div>
              <div class="itR">
                <button class="btn small good" onclick='approveProposal(${JSON.stringify(t)}).catch(e=>toast("Kunne ikke godkjenne: "+e.message,"bad"))'>Godkjenn</button>
                <button class="btn small bad" onclick='rejectProposal(${JSON.stringify(t)}).catch(e=>toast("Kunne ikke avvise: "+e.message,"bad"))'>Avvis</button>
              </div>
            </div>
          `).join("")}
        </div>

        <div class="hr"></div>

        <p class="title">‚úÖ Opprett familieoppgave</p>
        <div class="row">
          <input class="field" id="cTitle" placeholder="Oppgavetittel" />
          <input class="field" id="cAmount" type="number" min="0" placeholder="Bel√∏p (kr)" style="max-width:160px" />
          <select id="cCat" style="max-width:220px">
            <option value="hjemme">Hjemme</option>
            <option value="ute">Ute</option>
            <option value="annet">Annet</option>
          </select>
          <select id="cType" style="max-width:220px">
            <option value="once">Engang</option>
            <option value="weekly">Ukentlig</option>
          </select>
          <button class="btn primary" onclick="uiCreateFamilyTask()">Opprett</button>
        </div>
      </div>

      <div class="panel">
        <p class="title">‚è≥ Venter godkjenning (utf√∏rt)</p>
        <div class="muted">Workers med <code>completed_at</code> og uten <code>approved_at</code></div>

        <div class="list">
          ${completedWorkers.length===0 ? `<div class="muted">Ingen som venter p√• godkjenning n√•.</div>` : completedWorkers.map(w=>{
            const t = tasks.find(x=>x.id===w.task_id);
            const amount = t ? t.amount : 0;
            return `
              <div class="item">
                <div class="itL">
                  <div class="itT">${t ? escapeHtml(t.title) : `Oppgave #${w.task_id}`} <span class="muted">(${amount} kr)</span></div>
                  <div class="itM">Barn: <span style="color:${escapeHtml(w.worker_color)};font-weight:950">${escapeHtml(w.worker_name)}</span> ‚Ä¢ Fullf√∏rt: ${fmtShort(w.completed_at)}</div>
                </div>
                <div class="itR">
                  <button class="btn small good" onclick='approveWork(${JSON.stringify(w)}).catch(e=>toast("Kunne ikke godkjenne: "+e.message,"bad"))'>Godkjenn</button>
                  <button class="btn small bad" onclick='rejectWork(${JSON.stringify(w)}).catch(e=>toast("Kunne ikke avvise: "+e.message,"bad"))'>Avvis</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>

        <div class="hr"></div>

        <p class="title">üìå Tilgjengelige oppgaver</p>
        <div class="list">
          ${available.length===0 ? `<div class="muted">Ingen tilgjengelige oppgaver.</div>` : available.slice(0,20).map(t=>`
            <div class="item" style="border-left:6px solid ${escapeHtml(t.created_by_color)}">
              <div class="itL">
                <div class="itT">${escapeHtml(t.title)} <span class="muted">(${t.amount} kr)</span></div>
                <div class="itM">Laget av ${escapeHtml(t.created_by)} ‚Ä¢ ${escapeHtml(t.category||"hjemme")}</div>
              </div>
              <div class="itR"><span class="chip">Tilgjengelig</span></div>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `;
}
function uiCreateFamilyTask(){
  const title = document.getElementById("cTitle").value;
  const amount = document.getElementById("cAmount").value;
  const category = document.getElementById("cCat").value;
  const task_type = document.getElementById("cType").value;
  createFamilyTask({title, amount, category, task_type}).catch(e=>toast("Kunne ikke opprette: "+e.message,"bad"));
  document.getElementById("cTitle").value="";
  document.getElementById("cAmount").value="";
}

/* ============================================================
   NAV / SESSION
   ============================================================ */
function selectUser(name){
  const u = USERS.find(x=>x.name===name);
  if(!u) return;
  state.user = u;
  localStorage.setItem(LS_USER, name);
  refresh().catch(e=>toast("Kunne ikke laste data: "+e.message,"bad"));
  render();
}
function logout(){
  localStorage.removeItem(LS_USER);
  state.user = null;
  state.tab = "shopping";
  render();
}
function switchTab(id){
  state.tab = id;
  render();
}
function setWeek(val){
  state.ui.weekKey = val;
  render();
}

/* ============================================================
   REFRESH
   ============================================================ */
async function refresh(full=true){
  state.loading = true;
  render();
  try{
    if(full || state.tab==="shopping"){
      state.data.shopping = await loadShopping();
    }
    if(full || state.tab==="allowance"){
      const {tasks, workers, weekly} = await loadChores();
      state.data.choresTasks = tasks || [];
      state.data.choresWorkers = workers || [];
      state.data.weekly = weekly || [];
    }
  }catch(e){
    toast(e.message || "Noe gikk galt", "bad");
  }finally{
    state.loading = false;
    render();
  }
}

/* ============================================================
   BOOT
   ============================================================ */
(function boot(){
  const saved = localStorage.getItem(LS_USER);
  if(saved){
    const u = USERS.find(x=>x.name===saved);
    if(u) state.user = u;
  }
  render();
  if(state.user) refresh().catch(()=>{});
})();
</script>
</body>
</html>
