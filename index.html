<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Familietid</title>
  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f172a;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 24px 60px rgba(0,0,0,.35);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 500px at 40% 90%, rgba(236,72,153,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding:14px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius: calc(var(--r) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 18px;
      border-bottom:1px solid var(--border);
    }
    .topL{display:flex; gap:14px; align-items:center}
    .avatar{
      width:52px;height:52px;border-radius:16px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      font-size:26px;
    }
    .h1{margin:0;font-size:18px;font-weight:900;letter-spacing:.2px}
    .sub{margin:2px 0 0 0;color:var(--muted);font-size:12px;font-weight:700}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900; font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%;}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    .btn.primary{background: rgba(99,102,241,.22); border-color: rgba(99,102,241,.35)}
    .btn.good{background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.35)}
    .btn.small{padding:10px 12px;border-radius:12px}
    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }
    .tab{
      flex:1; min-width:140px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
      display:flex; gap:10px; align-items:center; justify-content:center;
    }
    .tab.active{background: rgba(99,102,241,.25); border-color: rgba(99,102,241,.35)}
    .content{padding:16px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row{display:flex; gap:10px; align-items:center}
    .item{
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px 16px;
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .item.checked{opacity:.55}
    .itemTop{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .itemTitle{font-weight:900}
    .itemSub{color:var(--muted);font-size:12px;margin-top:4px}
    .inp{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 14px;
      color:var(--text);
      font-size:14px;
      font-weight:700;
      width:100%;
    }
    .inp:focus{outline:2px solid rgba(99,102,241,.4)}
    select.inp{appearance:none;cursor:pointer}
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid;
    }
    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, rgba(99,102,241,.94), rgba(168,85,247,.94));
      color:#fff;
      padding:14px 20px;
      border-radius:18px;
      box-shadow:0 8px 30px rgba(0,0,0,.4);
      display:flex; gap:10px; align-items:center;
      font-weight:900; font-size:14px;
      transition: transform .28s cubic-bezier(.34,1.56,.64,1);
      z-index:9999;
      border:1px solid rgba(255,255,255,.2);
    }
    .toast.show{transform:translateX(-50%) translateY(0)}
    .toast.good{background: linear-gradient(135deg, rgba(34,197,94,.94), rgba(16,185,129,.94))}
    .toast.bad{background: linear-gradient(135deg, rgba(239,68,68,.94), rgba(220,38,38,.94))}
    .toast.warn{background: linear-gradient(135deg, rgba(245,158,11,.94), rgba(217,119,6,.94))}
    @media(max-width:640px){
      .grid2{grid-template-columns:1fr}
      .top{flex-direction:column;align-items:flex-start}
      .row{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ============================================================
   SUPABASE (prefylt)
   ============================================================ */
const SUPABASE_URL = "https://tifhelbmaqoojqtqhzso.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpZmhlbGJtYXFvb2pxdHFoenNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODY5NTYsImV4cCI6MjA4NDA2Mjk1Nn0.WFMmeOZvEYL9AAoLRHFVx97b8hT9Z2us-iWAxAjv9Fg";

/* ============================================================
   USERS (enkel "rolle"-styring uten auth)
   ============================================================ */
const USERS = [
  { name:"Emmie",   emoji:"üå∏", color:"#ff6b9d", role:"child"  },
  { name:"Thelma",  emoji:"ü¶ã", color:"#c471ed", role:"child"  },
  { name:"Elea",    emoji:"üåü", color:"#f9ca24", role:"child"  },
  { name:"Katrine", emoji:"üå∫", color:"#ff7979", role:"parent" },
  { name:"Kim Rune",emoji:"‚ö°", color:"#4a90e2", role:"parent" },
];

const LS_USER = "familietid_user_v2";

/* ============================================================
   STATE
   ============================================================ */
const state = {
  user: null,
  tab: "shopping",
  loading: false,
  data: {
    shopping: [],
    choresTasks: [],
    choresWorkers: [],
    weekly: [],
  },
  ui: {
    weekKey: "auto", // auto => current week if exists else latest
  }
};

const appEl = document.getElementById("app");
const toastEl = document.getElementById("toast");

/* ============================================================
   UTIL
   ============================================================ */
function toast(msg, type="good"){
  const icon = type==="good"?"‚úÖ":type==="bad"?"‚ùå":"‚ö†Ô∏è";
  toastEl.className = `toast show ${type}`;
  toastEl.innerHTML = `<span>${icon}</span><span>${escapeHtml(msg)}</span>`;
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>{ toastEl.className="toast"; }, 2600);
}
function escapeHtml(s){
  return (s ?? "").toString().replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function isoDate(d=new Date()){ return new Date(d).toISOString(); }
function nowISO(){ return new Date().toISOString(); }
function fmtShort(iso){
  if(!iso) return "";
  return new Date(iso).toLocaleString("no-NO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});
}
function currentISOWeekKey(){
  // ISO week key: YYYY-Www
  const d = new Date();
  const target = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNr = (target.getUTCDay() + 6) % 7;
  target.setUTCDate(target.getUTCDate() - dayNr + 3);
  const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
  const diff = target - firstThursday;
  const week = 1 + Math.round(diff / 604800000);
  const year = target.getUTCFullYear();
  return `${year}-W${String(week).padStart(2,"0")}`;
}
function weekKeyFromRow(r){ return `${r.year}-W${String(r.week).padStart(2,"0")}`; }

/* ============================================================
   SUPABASE REST HELPERS
   ============================================================ */
async function sb(path, { method="GET", body=null, headers={} }={}){
  const url = `${SUPABASE_URL}/rest/v1/${path}`;
  const res = await fetch(url, {
    method,
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json",
      "Prefer": "return=representation",
      ...headers
    },
    body: body ? JSON.stringify(body) : null
  });
  const text = await res.text();
  const data = text ? JSON.parse(text) : null;
  if(!res.ok){
    console.error("Supabase error:", {status: res.status, data, url});
    throw new Error((data && (data.message || data.error_description)) || text || `HTTP ${res.status}`);
  }
  return data;
}
function q(s){ return encodeURIComponent(s); }

/* ============================================================
   LOADERS
   ============================================================ */
async function loadShopping(){
  return await sb(`shopping_items?select=*&order=timestamp.desc`);
}
async function loadChores(){
  const [tasks, workers] = await Promise.all([
    sb(`chore_tasks?select=*&order=created_at.desc`),
    sb(`chore_workers?select=*&order=started_at.desc`),
  ]);
  
  // Compute weekly earnings on the fly instead of using a view
  const weekly = computeWeeklyEarnings(workers, tasks);
  
  return { tasks, workers, weekly };
}

function computeWeeklyEarnings(workers, tasks) {
  const byWeek = {};
  
  workers.forEach(w => {
    if (!w.approved_at) return;
    const task = tasks.find(t => t.id === w.task_id);
    if (!task) return;
    
    const d = new Date(w.approved_at);
    const weekKey = getWeekKeyFromDate(d);
    const year = d.getFullYear();
    const week = parseInt(weekKey.split('-W')[1]);
    
    const key = `${w.worker_name}-${weekKey}`;
    if (!byWeek[key]) {
      byWeek[key] = {
        worker_name: w.worker_name,
        year: year,
        week: week,
        total_earned: 0
      };
    }
    byWeek[key].total_earned += (w.earned_amount || 0);
  });
  
  return Object.values(byWeek);
}

function getWeekKeyFromDate(date) {
  const target = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNr = (target.getUTCDay() + 6) % 7;
  target.setUTCDate(target.getUTCDate() - dayNr + 3);
  const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
  const diff = target - firstThursday;
  const week = 1 + Math.round(diff / 604800000);
  const year = target.getUTCFullYear();
  return `${year}-W${String(week).padStart(2,"0")}`;
}

/* ============================================================
   SHOPPING ACTIONS
   ============================================================ */
async function addShopping(text, qty){
  if(!text.trim()) return toast("Skriv inn en vare f√∏rst", "warn");
  const row = {
    text: text.trim(),
    quantity: Number(qty)||1,
    checked: false,
    added_by: state.user.name,
    added_by_color: state.user.color,
    timestamp: nowISO()
  };
  await sb(`shopping_items`, { method:"POST", body: row });
  toast("Lagt til!", "good");
  await refresh();
}
async function toggleShopping(item){
  await sb(`shopping_items?id=eq.${item.id}`, {
    method:"PATCH",
    body: { checked: !item.checked }
  });
  await refresh(false);
}
async function deleteShopping(item){
  await sb(`shopping_items?id=eq.${item.id}`, { method:"DELETE", headers: {"Prefer":"return=minimal"} });
  toast("Slettet", "warn");
  await refresh();
}

/* ============================================================
   CHORES / UKEL√òNN ACTIONS
   ============================================================ */
function isParent(){ return state.user?.role === "parent"; }
function isChild(){ return state.user?.role === "child"; }

async function createFamilyTask({title, amount, category, task_type}){
  if(!isParent()) return toast("Kun foreldre kan opprette familieoppgaver", "warn");
  if(!title.trim()) return toast("Oppgavetittel mangler", "warn");
  const row = {
    title: title.trim(),
    description: null,
    amount: Number(amount)||0,
    task_type: task_type || "once",
    category: category || "hjemme",
    status: "available",
    created_by: state.user.name,
    created_by_color: state.user.color,
    proposed_by_child: false,
    created_at: nowISO()
  };
  await sb(`chore_tasks`, { method:"POST", body: row });
  toast("Oppgave opprettet", "good");
  await refresh();
}

async function proposeTask({title, amount, category}){
  if(!isChild()) return toast("Kun barn kan foresl√• oppgaver her", "warn");
  if(!title.trim()) return toast("Oppgavetittel mangler", "warn");
  const row = {
    title: title.trim(),
    description: "Foresl√•tt av barn",
    amount: Number(amount)||0,
    task_type: "once",
    category: category || "hjemme",
    status: "proposed",
    created_by: state.user.name,
    created_by_color: state.user.color,
    proposed_by_child: true,
    created_at: nowISO()
  };
  await sb(`chore_tasks`, { method:"POST", body: row });
  toast("Forslag sendt til godkjenning", "good");
  await refresh();
}

async function approveProposal(task){
  if(!isParent()) return toast("Kun foreldre kan godkjenne forslag", "warn");
  await sb(`chore_tasks?id=eq.${task.id}`, {
    method:"PATCH",
    body: { status:"available", approved_by: state.user.name, approved_at: nowISO() }
  });
  toast("Forslag godkjent", "good");
  await refresh();
}
async function rejectProposal(task){
  if(!isParent()) return toast("Kun foreldre kan avvise forslag", "warn");
  await sb(`chore_tasks?id=eq.${task.id}`, {
    method:"PATCH",
    body: { status:"rejected", approved_by: state.user.name, approved_at: nowISO() }
  });
  toast("Forslag avvist", "warn");
  await refresh();
}

async function takeTask(task){
  if(!isChild()) return toast("Kun barn kan ta oppgaver", "warn");
  // Lag worker-rad
  const worker = {
    task_id: task.id,
    worker_name: state.user.name,
    worker_color: state.user.color,
    percentage: 100,
    confirmed: true,
    started_at: nowISO()
  };
  await sb(`chore_workers`, { method:"POST", body: worker });
  // Oppdater status p√• task (valgfritt men ryddig)
  await sb(`chore_tasks?id=eq.${task.id}`, { method:"PATCH", body: { status:"assigned" } });
  toast("Oppgave tatt", "good");
  await refresh();
}

async function completeMyWork(worker){
  if(!isChild()) return toast("Kun barn kan fullf√∏re", "warn");
  if(worker.worker_name !== state.user.name) return toast("Dette er ikke din oppgave", "warn");
  await sb(`chore_workers?id=eq.${worker.id}`, { method:"PATCH", body: { completed_at: nowISO() } });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"completed" } });
  toast("Fullf√∏rt ‚Äì venter p√• godkjenning", "warn");
  await refresh();
}

async function approveWork(worker){
  if(!isParent()) return toast("Kun foreldre kan godkjenne", "warn");
  // Finn task (for bel√∏p)
  const task = state.data.choresTasks.find(t => t.id === worker.task_id);
  if(!task) return toast("Fant ikke oppgaven", "bad");
  const earned = Math.round((task.amount || 0) * ((worker.percentage||100)/100));
  await sb(`chore_workers?id=eq.${worker.id}`, {
    method:"PATCH",
    body: { approved_at: nowISO(), approved_by: state.user.name, earned_amount: earned }
  });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"approved" } });
  toast("Godkjent ‚úÖ", "good");
  await refresh();
}

async function rejectWork(worker){
  if(!isParent()) return toast("Kun foreldre kan avvise", "warn");
  await sb(`chore_workers?id=eq.${worker.id}`, {
    method:"PATCH",
    body: { rejected_at: nowISO(), rejected_by: state.user.name }
  });
  await sb(`chore_tasks?id=eq.${worker.task_id}`, { method:"PATCH", body: { status:"available" } });
  toast("Avvist ‚Äì tilbake til tilgjengelig", "warn");
  await refresh();
}

/* ============================================================
   RENDER
   ============================================================ */
function render(){
  if(!state.user){
    appEl.innerHTML = `
      <div class="top">
        <div class="topL">
          <div class="avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <div>
            <p class="h1">Familietid</p>
            <p class="sub">Velg bruker</p>
          </div>
        </div>
        <span class="pill"><span class="dot" style="background:${state.loading? "var(--warn)":"var(--good)"}"></span>${state.loading?"Laster‚Ä¶":"Klar"}</span>
      </div>
      <div class="content">
        <div class="grid2">
          ${USERS.map(u=>`
            <button class="btn" onclick="selectUser('${u.name}')"
              style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:18px;">
              <span style="display:flex;gap:12px;align-items:center">
                <span style="width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);font-size:20px">${u.emoji}</span>
                <span style="text-align:left">
                  <div style="font-weight:950">${escapeHtml(u.name)}</div>
                  <div class="muted" style="font-size:12px">${u.role==="parent"?"Forelder":"Barn"}</div>
                </span>
              </span>
              <span class="chip" style="border-color:${u.color}55">${u.color}</span>
            </button>
          `).join("")}
        </div>
      </div>
    `;
    return;
  }

  const tab = state.tab;
  const tabButtons = [
    { id:"shopping", label:"Handleliste", icon:"üõí" },
    { id:"allowance", label:"Ukel√∏nn", icon:"üí∞" },
  ];

  appEl.innerHTML = `
    <div class="top">
      <div class="topL">
        <div class="avatar" style="border-color:${state.user.color}55">${state.user.emoji}</div>
        <div>
          <p class="h1">Hei, ${escapeHtml(state.user.name)}!</p>
          <p class="sub">${state.user.role==="parent"?"Forelder":"Barn"} ‚Ä¢ Familietid</p>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <span class="pill"><span class="dot" style="background:${state.loading? "var(--warn)":"var(--good)"}"></span>${state.loading?"Laster‚Ä¶":"Online"}</span>
        <button class="btn small" onclick="refresh()">Oppdater</button>
        <button class="btn small" onclick="logout()">Bytt bruker</button>
      </div>
    </div>

    <div class="tabs">
      ${tabButtons.map(t=>`
        <button class="tab ${tab===t.id?"active":""}" onclick="switchTab('${t.id}')">
          <span>${t.icon}</span><span>${t.label}</span>
        </button>
      `).join("")}
    </div>

    <div class="content">
      ${tab==="shopping"? renderShopping() : tab==="allowance"? renderAllowance() : ""}
    </div>
  `;
}

function renderShopping(){
  const items = state.data.shopping || [];
  return `
    <div class="row" style="margin-bottom:16px">
      <input id="shopText" class="inp" placeholder="Hva skal vi handle?" />
      <input id="shopQty" type="number" class="inp" value="1" min="1" style="width:80px" />
      <button class="btn good" onclick="doAddShopping()">+ Legg til</button>
    </div>
    ${items.length===0? `<p style="color:var(--muted);text-align:center;padding:30px 0">Handlelisten er tom</p>` : ""}
    ${items.map(i=>`
      <div class="item ${i.checked?"checked":""}">
        <div class="itemTop">
          <div style="flex:1">
            <div class="itemTitle">${escapeHtml(i.text)} <span class="badge" style="border-color:${i.added_by_color};color:${i.added_by_color}">√ó${i.quantity}</span></div>
            <div class="itemSub">${escapeHtml(i.added_by)} ‚Ä¢ ${fmtShort(i.timestamp)}</div>
          </div>
          <div class="row">
            <button class="btn small ${i.checked?"":"good"}" onclick="toggleShopping(${i.id})">${i.checked?"‚Ü∫":"‚úì"}</button>
            <button class="btn small bad" onclick="deleteShopping(${i.id})">üóë</button>
          </div>
        </div>
      </div>
    `).join("")}
  `;
}

function renderAllowance(){
  const tasks = state.data.choresTasks || [];
  const workers = state.data.choresWorkers || [];
  const weekly = state.data.weekly || [];

  const available = tasks.filter(t=>t.status==="available");
  const proposed = tasks.filter(t=>t.status==="proposed");
  const myWork = workers.filter(w=>w.worker_name===state.user.name && !w.completed_at && !w.approved_at);
  const completed = workers.filter(w=>w.completed_at && !w.approved_at && !w.rejected_at);

  let html = "";

  // Create task (parent)
  if(isParent()){
    html += `
      <fieldset style="border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:20px">
        <legend style="font-weight:900">Opprett oppgave</legend>
        <input id="cTitle" class="inp" placeholder="Tittel" style="margin-bottom:10px" />
        <div class="row" style="margin-bottom:10px">
          <input id="cAmount" type="number" class="inp" placeholder="Bel√∏p kr" />
          <select id="cCat" class="inp">
            <option value="hjemme">üè† Hjemme</option>
            <option value="ute">üå≥ Ute</option>
            <option value="kjaeledyr">üêæ Kj√¶ledyr</option>
            <option value="skole">üìö Skole</option>
          </select>
          <select id="cType" class="inp">
            <option value="once">Engangs</option>
            <option value="weekly">Ukentlig</option>
          </select>
        </div>
        <button class="btn good" onclick="doCreateTask()">Opprett</button>
      </fieldset>
    `;
  }

  // Propose task (child)
  if(isChild()){
    html += `
      <fieldset style="border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:20px">
        <legend style="font-weight:900">üí° Foresl√• oppgave</legend>
        <input id="pTitle" class="inp" placeholder="Hva vil du gj√∏re?" style="margin-bottom:10px" />
        <div class="row" style="margin-bottom:10px">
          <input id="pAmount" type="number" class="inp" placeholder="Bel√∏p kr" />
          <select id="pCat" class="inp">
            <option value="hjemme">üè† Hjemme</option>
            <option value="ute">üå≥ Ute</option>
            <option value="kjaeledyr">üêæ Kj√¶ledyr</option>
            <option value="skole">üìö Skole</option>
          </select>
        </div>
        <button class="btn good" onclick="doProposeTask()">Send forslag</button>
      </fieldset>
    `;
  }

  // Proposals (parent view)
  if(isParent() && proposed.length>0){
    html += `<h3 style="margin-top:20px">üí° Forslag fra barn</h3>`;
    proposed.forEach(t=>{
      html += `
        <div class="item">
          <div class="itemTop">
            <div style="flex:1">
              <div class="itemTitle">${escapeHtml(t.title)} <span class="badge" style="border-color:var(--warn);color:var(--warn)">${t.amount} kr</span></div>
              <div class="itemSub">Foresl√•tt av ${escapeHtml(t.created_by)}</div>
            </div>
            <div class="row">
              <button class="btn small good" onclick="approveProposal(${t.id})">‚úì Godkjenn</button>
              <button class="btn small bad" onclick="rejectProposal(${t.id})">‚úó Avvis</button>
            </div>
          </div>
        </div>
      `;
    });
  }

  // Available tasks
  if(available.length>0){
    html += `<h3 style="margin-top:20px">üìã Tilgjengelige oppgaver</h3>`;
    available.forEach(t=>{
      html += `
        <div class="item">
          <div class="itemTop">
            <div style="flex:1">
              <div class="itemTitle">${escapeHtml(t.title)} <span class="badge" style="border-color:var(--good);color:var(--good)">${t.amount} kr</span></div>
              <div class="itemSub">${t.category} ‚Ä¢ ${t.task_type==="weekly"?"üîÅ Ukentlig":"‚úÖ Engangs"}</div>
            </div>
            ${isChild()?`<button class="btn small good" onclick="takeTask(${t.id})">Ta oppgave</button>`:""}
          </div>
        </div>
      `;
    });
  }

  // My work (child)
  if(isChild() && myWork.length>0){
    html += `<h3 style="margin-top:20px">‚è≥ Mine p√•begynte oppgaver</h3>`;
    myWork.forEach(w=>{
      const task = tasks.find(t=>t.id===w.task_id);
      if(!task) return;
      html += `
        <div class="item">
          <div class="itemTop">
            <div style="flex:1">
              <div class="itemTitle">${escapeHtml(task.title)} <span class="badge" style="border-color:var(--warn);color:var(--warn)">${task.amount} kr</span></div>
              <div class="itemSub">Tatt ${fmtShort(w.started_at)}</div>
            </div>
            <button class="btn small good" onclick="completeMyWork(${w.id})">‚úì Ferdig</button>
          </div>
        </div>
      `;
    });
  }

  // Completed waiting approval (parent)
  if(isParent() && completed.length>0){
    html += `<h3 style="margin-top:20px">‚è∞ Venter p√• godkjenning</h3>`;
    completed.forEach(w=>{
      const task = tasks.find(t=>t.id===w.task_id);
      if(!task) return;
      html += `
        <div class="item">
          <div class="itemTop">
            <div style="flex:1">
              <div class="itemTitle">${escapeHtml(task.title)} <span class="badge" style="border-color:var(--good);color:var(--good)">${task.amount} kr</span></div>
              <div class="itemSub">Fullf√∏rt av ${escapeHtml(w.worker_name)} ${fmtShort(w.completed_at)}</div>
            </div>
            <div class="row">
              <button class="btn small good" onclick="approveWork(${w.id})">‚úì Godkjenn</button>
              <button class="btn small bad" onclick="rejectWork(${w.id})">‚úó Avvis</button>
            </div>
          </div>
        </div>
      `;
    });
  }

  // Weekly earnings overview
  if(weekly.length>0){
    html += `<h3 style="margin-top:30px">üìä Ukeoversikt</h3>`;
    const grouped = {};
    weekly.forEach(r=>{
      const k = weekKeyFromRow(r);
      if(!grouped[k]) grouped[k] = [];
      grouped[k].push(r);
    });
    const sorted = Object.keys(grouped).sort().reverse();
    sorted.slice(0,4).forEach(k=>{
      const rows = grouped[k];
      html += `<div style="border:1px solid var(--border);border-radius:var(--r);padding:12px;margin-bottom:10px">
        <div style="font-weight:900;margin-bottom:8px">Uke ${k}</div>
        ${rows.map(r=>`<div style="display:flex;justify-content:space-between;font-size:14px;margin-bottom:4px">
          <span>${escapeHtml(r.worker_name)}</span><span style="font-weight:900;color:var(--good)">${r.total_earned} kr</span>
        </div>`).join("")}
      </div>`;
    });
  }

  return html;
}

/* ============================================================
   ACTIONS WRAPPED
   ============================================================ */
function doAddShopping(){
  const text = document.getElementById("shopText").value;
  const qty = document.getElementById("shopQty").value;
  addShopping(text, qty).catch(e=>toast("Kunne ikke legge til: "+e.message,"bad"));
  document.getElementById("shopText").value="";
  document.getElementById("shopQty").value="1";
}
function toggleShopping(id){
  const item = state.data.shopping.find(i=>i.id===id);
  if(item) toggleShopping(item).catch(e=>toast("Feil: "+e.message,"bad"));
}
function deleteShopping(id){
  const item = state.data.shopping.find(i=>i.id===id);
  if(item) deleteShopping(item).catch(e=>toast("Feil: "+e.message,"bad"));
}
function takeTask(id){
  const task = state.data.choresTasks.find(t=>t.id===id);
  if(task) takeTask(task).catch(e=>toast("Feil: "+e.message,"bad"));
}
function completeMyWork(id){
  const worker = state.data.choresWorkers.find(w=>w.id===id);
  if(worker) completeMyWork(worker).catch(e=>toast("Feil: "+e.message,"bad"));
}
function approveWork(id){
  const worker = state.data.choresWorkers.find(w=>w.id===id);
  if(worker) approveWork(worker).catch(e=>toast("Feil: "+e.message,"bad"));
}
function rejectWork(id){
  const worker = state.data.choresWorkers.find(w=>w.id===id);
  if(worker) rejectWork(worker).catch(e=>toast("Feil: "+e.message,"bad"));
}
function approveProposal(id){
  const task = state.data.choresTasks.find(t=>t.id===id);
  if(task) approveProposal(task).catch(e=>toast("Feil: "+e.message,"bad"));
}
function rejectProposal(id){
  const task = state.data.choresTasks.find(t=>t.id===id);
  if(task) rejectProposal(task).catch(e=>toast("Feil: "+e.message,"bad"));
}

function doProposeTask(){
  const title = document.getElementById("pTitle").value;
  const amount = document.getElementById("pAmount").value;
  const category = document.getElementById("pCat").value;
  proposeTask({title, amount, category}).catch(e=>toast("Kunne ikke foresl√•: "+e.message,"bad"));
  document.getElementById("pTitle").value="";
  document.getElementById("pAmount").value="";
}

function doCreateTask(){
  const title = document.getElementById("cTitle").value;
  const amount = document.getElementById("cAmount").value;
  const category = document.getElementById("cCat").value;
  const task_type = document.getElementById("cType").value;
  createFamilyTask({title, amount, category, task_type}).catch(e=>toast("Kunne ikke opprette: "+e.message,"bad"));
  document.getElementById("cTitle").value="";
  document.getElementById("cAmount").value="";
}

/* ============================================================
   NAV / SESSION
   ============================================================ */
function selectUser(name){
  const u = USERS.find(x=>x.name===name);
  if(!u) return;
  state.user = u;
  localStorage.setItem(LS_USER, name);
  refresh().catch(e=>toast("Kunne ikke laste data: "+e.message,"bad"));
  render();
}
function logout(){
  localStorage.removeItem(LS_USER);
  state.user = null;
  state.tab = "shopping";
  render();
}
function switchTab(id){
  state.tab = id;
  render();
}
function setWeek(val){
  state.ui.weekKey = val;
  render();
}

/* ============================================================
   REFRESH
   ============================================================ */
async function refresh(full=true){
  state.loading = true;
  render();
  try{
    if(full || state.tab==="shopping"){
      state.data.shopping = await loadShopping();
    }
    if(full || state.tab==="allowance"){
      const {tasks, workers, weekly} = await loadChores();
      state.data.choresTasks = tasks || [];
      state.data.choresWorkers = workers || [];
      state.data.weekly = weekly || [];
    }
  }catch(e){
    console.error("Refresh error:", e);
    toast(e.message || "Noe gikk galt", "bad");
  }finally{
    state.loading = false;
    render();
  }
}

/* ============================================================
   BOOT
   ============================================================ */
(function boot(){
  const saved = localStorage.getItem(LS_USER);
  if(saved){
    const u = USERS.find(x=>x.name===saved);
    if(u) state.user = u;
  }
  render();
  if(state.user) refresh().catch(()=>{});
})();
</script>
</body>
</html>
