<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Familietid</title>
  <style>
    :root{
      --bg1:#ffecd2; --bg2:#fcb69f;
      --card:#fff; --text:#111827; --muted:#6b7280;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      padding:14px;
    }
    .wrap{max-width:920px;margin:0 auto}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow)}
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:18px;
      border-radius:var(--radius);
      color:#fff;
    }
    .topL{display:flex; align-items:center; gap:14px}
    .emoji{font-size:40px; line-height:1}
    .h1{margin:0; font-weight:900; font-size:20px}
    .sub{margin:2px 0 0 0; opacity:.9; font-size:13px}
    .btn{
      border:0; cursor:pointer; font-weight:900;
      border-radius:14px; padding:12px 14px;
      user-select:none;
    }
    .btn.ghost{background:rgba(255,255,255,.18); color:#fff; border:2px solid rgba(255,255,255,.35)}
    .btn.primary{background:#111827; color:#fff}
    .btn.danger{background:#ef4444; color:#fff}
    .btn.ok{background:#16a34a; color:#fff}
    .btn.small{padding:10px 12px; border-radius:12px; font-weight:900}
    .tabs{display:flex; flex-wrap:wrap; gap:10px; margin:14px 0}
    .tab{
      flex:1; min-width:145px;
      padding:14px 12px;
      border-radius:16px;
      background:#fff;
      color:#111827;
      border:3px solid transparent;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{color:#fff}
    .content{padding:18px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{
      width:100%;
      border:2px solid #e5e7eb;
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    .field:focus{border-color:#11182733}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:#11182710;
      color:#111827;
    }
    .list{display:flex; flex-direction:column; gap:10px; margin-top:12px}
    .item{
      background:#f8fafc;
      border-radius:16px;
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-left:6px solid #11182733;
    }
    .item .title{font-weight:900; font-size:16px}
    .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .muted{color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:780px){
      body{padding:10px}
      .btn{padding:16px 14px}
      .tab{min-width:130px}
      .grid2{grid-template-columns:1fr}
      .content{padding:14px}
    }

    /* Toast */
    .toast{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:12px 16px;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      z-index:9999;
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      max-width:min(780px,92vw);
      cursor:pointer;
      opacity:0; transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .toast.success{background:#16a34a}
    .toast.warn{background:#f59e0b}
    .toast.error{background:#ef4444}
    .toast .hint{opacity:.9; font-weight:800; font-size:12px}
    .sep{height:1px; background:#e5e7eb; margin:14px 0}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      background:#11182710;
      padding:8px 10px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="app" class="card"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/** ============================================================
 *  Familietid ‚Äì √©n-fil app (Supabase REST via fetch)
 *  Ingen eksterne biblioteker, ingen ‚Äúevig loading‚Äù.
 *  ============================================================ */

/* === Supabase (prefylt) === */
const SUPABASE_URL = "https://tifhelbmaqoojqtqhzso.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpZmhlbGJtYXFvb2pxdHFoenNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODY5NTYsImV4cCI6MjA4NDA2Mjk1Nn0.WFMmeOZvEYL9AAoLRHFVx97b8hT9Z2us-iWAxAjv9Fg";

/* === ‚ÄúFamiliebrukere‚Äù === */
const USERS = [
  { name:"Emmie",   emoji:"üå∏", color:"#ff6b9d", role:"child"  },
  { name:"Thelma",  emoji:"ü¶ã", color:"#c471ed", role:"child"  },
  { name:"Elea",    emoji:"üåü", color:"#f9ca24", role:"child"  },
  { name:"Katrine", emoji:"üå∫", color:"#ff7979", role:"parent" },
  { name:"Kim Rune",emoji:"‚ö°", color:"#4a90e2", role:"parent" },
];

const LS_KEY = "familietid_user";

/* === App state === */
const state = {
  user: null,
  tab: "shopping",
  online: true,
  loading: { shopping:false, calendar:false, notes:false, maintenance:false, allowance:false },
  data: {
    shopping: [],
    calendar: [],
    notes: [],
    maintenance: [],
    chores: [],
    workers: [],
  },
  lastDeleted: null, // for undo
};

const appEl = document.getElementById("app");
const toastEl = document.getElementById("toast");

/* ============================================================
 *  Helpers
 * ============================================================ */
function escapeHtml(s){
  return (s ?? "").toString().replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function fmtAgo(iso){
  if(!iso) return "";
  const d = new Date(iso);
  const diff = Date.now() - d.getTime();
  const m = Math.floor(diff/60000);
  const h = Math.floor(diff/3600000);
  const day = Math.floor(diff/86400000);
  if(m < 1) return "akkurat n√•";
  if(m < 60) return `${m} min siden`;
  if(h < 24) return `${h} t siden`;
  return d.toLocaleString("no-NO", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
}
function fmtDateOnly(iso){
  const d = new Date(iso);
  return d.toLocaleDateString("no-NO", { weekday:"short", day:"2-digit", month:"short" });
}
function fmtTimeOnly(iso){
  const d = new Date(iso);
  return d.toLocaleTimeString("no-NO", { hour:"2-digit", minute:"2-digit" });
}
function isParent(){
  return state.user?.role === "parent";
}

function toast(msg, type="success", hint=""){
  toastEl.className = `toast ${type}`;
  toastEl.innerHTML = `<div>${type==="success"?"‚úÖ":type==="warn"?"‚ö†Ô∏è":"‚ùå"}</div>
                       <div><div>${escapeHtml(msg)}</div>${hint?`<div class="hint">${escapeHtml(hint)}</div>`:""}</div>`;
  toastEl.onclick = () => {
    if(state.lastDeleted){
      undoLastDelete();
    } else {
      hideToast();
    }
  };
  requestAnimationFrame(()=>{
    toastEl.classList.add("show");
  });
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(hideToast, 3300);
}
function hideToast(){ toastEl.classList.remove("show"); }

function setOnlineFlag(ok){
  state.online = ok;
}

/* ============================================================
 *  Supabase REST wrapper
 * ============================================================ */
async function sb(path, { method="GET", query={}, body=null, prefer="return=representation" } = {}){
  const url = new URL(`${SUPABASE_URL}/rest/v1/${path}`);
  for(const [k,v] of Object.entries(query || {})){
    url.searchParams.set(k, v);
  }
  const res = await fetch(url.toString(), {
    method,
    headers: {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json",
      "Prefer": prefer,
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const text = await res.text().catch(()=> "");
    throw new Error(`${res.status} ${res.statusText} :: ${text}`);
  }
  if(res.status === 204) return null;
  return res.json();
}

/* ============================================================
 *  Data loaders
 * ============================================================ */
async function loadShopping(){
  state.loading.shopping = true; render();
  try{
    const rows = await sb("shopping_items", { query:{ select:"*", order:"timestamp.desc" } });
    state.data.shopping = rows || [];
    setOnlineFlag(true);
  } catch(e){
    console.error(e);
    setOnlineFlag(false);
    toast("Kunne ikke hente handleliste (offline?)", "warn", "Du kan fortsatt bruke appen ‚Äì pr√∏ver igjen senere.");
  } finally{
    state.loading.shopping = false; render();
  }
}

async function loadNotes(){
  state.loading.notes = true; render();
  try{
    const rows = await sb("notes", { query:{ select:"*", order:"timestamp.desc" } });
    state.data.notes = rows || [];
    setOnlineFlag(true);
  } catch(e){
    console.error(e);
    setOnlineFlag(false);
    toast("Kunne ikke hente notater", "warn");
  } finally{
    state.loading.notes = false; render();
  }
}

async function loadMaintenance(){
  state.loading.maintenance = true; render();
  try{
    const rows = await sb("maintenance_tasks", { query:{ select:"*", order:"priority.asc" } });
    state.data.maintenance = rows || [];
    setOnlineFlag(true);
  } catch(e){
    console.error(e);
    setOnlineFlag(false);
    toast("Kunne ikke hente vedlikehold", "warn");
  } finally{
    state.loading.maintenance = false; render();
  }
}

async function loadCalendar(){
  state.loading.calendar = true; render();
  try{
    // Henter 120 dager frem + 30 dager tilbake (bredt nok for familiebruk)
    const from = new Date(Date.now() - 30*86400000).toISOString();
    const to   = new Date(Date.now() + 120*86400000).toISOString();
    const rows = await sb("calendar_events", {
      query:{
        select:"*",
        "start_time": `gte.${from}`,
        "start_time": `gte.${from}`, // PostgREST bruker siste hvis du dobler ‚Äì s√• vi gj√∏r det i URL p√• annen m√•te under
      }
    });
    // Over: begrensning i v√•r wrapper hvis samme key brukes to ganger.
    // L√∏sning: hent alt sortert, og filter client-side.
    // (Kalender-tabellen er normalt liten i familie-app.)
    const all = await sb("calendar_events", { query:{ select:"*", order:"start_time.asc" } });
    state.data.calendar = (all || []).filter(ev=>{
      const t = new Date(ev.start_time).getTime();
      return t >= (Date.now() - 30*86400000) && t <= (Date.now() + 120*86400000);
    });
    setOnlineFlag(true);
  } catch(e){
    console.error(e);
    setOnlineFlag(false);
    toast("Kunne ikke hente kalender", "warn");
  } finally{
    state.loading.calendar = false; render();
  }
}

async function loadAllowance(){
  state.loading.allowance = true; render();
  try{
    const chores = await sb("chore_tasks", { query:{ select:"*", order:"created_at.desc" } });
    const workers = await sb("chore_workers", { query:{ select:"*", order:"started_at.desc" } });
    state.data.chores = chores || [];
    state.data.workers = workers || [];
    setOnlineFlag(true);
  } catch(e){
    console.error(e);
    setOnlineFlag(false);
    toast("Kunne ikke hente ukel√∏nn-data", "warn");
  } finally{
    state.loading.allowance = false; render();
  }
}

/* ============================================================
 *  Actions ‚Äì Shopping
 * ============================================================ */
async function addShopping(){
  const text = document.getElementById("shop_text").value.trim();
  const qty  = parseInt(document.getElementById("shop_qty").value || "1", 10);
  if(!text) return toast("Skriv inn en vare f√∏rst", "warn");
  try{
    const row = await sb("shopping_items", {
      method:"POST",
      body:{
        text,
        quantity: isFinite(qty) && qty>0 ? qty : 1,
        checked:false,
        added_by: state.user.name,
        added_by_color: state.user.color
      }
    });
    // row kan v√¶re array eller object avhengig av prefer; vi bruker return=representation => array
    const inserted = Array.isArray(row) ? row[0] : row;
    if(inserted) state.data.shopping.unshift(inserted);
    document.getElementById("shop_text").value = "";
    document.getElementById("shop_qty").value = "1";
    toast("Vare lagt til");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke lagre vare", "error", "Sjekk at RLS er av/policies tillater insert.");
  }
}

async function toggleShopping(id, current){
  try{
    const row = await sb(`shopping_items?id=eq.${id}`, {
      method:"PATCH",
      body:{ checked: !current }
    });
    // update local
    const idx = state.data.shopping.findIndex(x=>x.id===id);
    if(idx>=0) state.data.shopping[idx].checked = !current;
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke oppdatere vare", "error");
  }
}

async function deleteShopping(id){
  const item = state.data.shopping.find(x=>x.id===id);
  if(!item) return;
  state.lastDeleted = { type:"shopping", payload:item, when:Date.now() };
  try{
    await sb(`shopping_items?id=eq.${id}`, { method:"DELETE", prefer:"return=minimal" });
    state.data.shopping = state.data.shopping.filter(x=>x.id!==id);
    toast(`Slettet: ${item.text}`, "warn", "Klikk p√• toasten for √• angre");
    render();
  } catch(e){
    console.error(e);
    state.lastDeleted = null;
    toast("Kunne ikke slette", "error");
  }
}

async function undoLastDelete(){
  const d = state.lastDeleted;
  if(!d) return;
  // kun angre siste 20 sek
  if(Date.now() - d.when > 20000){
    state.lastDeleted = null;
    return toast("For sent √• angre", "warn");
  }
  try{
    if(d.type === "shopping"){
      const it = d.payload;
      // re-insert (ny id)
      const row = await sb("shopping_items", {
        method:"POST",
        body:{
          text: it.text,
          quantity: it.quantity ?? 1,
          checked: it.checked ?? false,
          added_by: it.added_by || state.user.name,
          added_by_color: it.added_by_color || state.user.color
        }
      });
      const inserted = Array.isArray(row) ? row[0] : row;
      if(inserted) state.data.shopping.unshift(inserted);
      state.lastDeleted = null;
      toast("Angret ‚Äì varen er tilbake");
      render();
      return;
    }
  } catch(e){
    console.error(e);
    toast("Kunne ikke angre", "error");
  } finally{
    state.lastDeleted = null;
  }
}

/* ============================================================
 *  Actions ‚Äì Notes
 * ============================================================ */
async function addNote(){
  const txt = document.getElementById("note_text").value.trim();
  if(!txt) return toast("Skriv et notat f√∏rst", "warn");
  try{
    const row = await sb("notes", {
      method:"POST",
      body:{
        text: txt,
        added_by: state.user.name,
        added_by_color: state.user.color
      }
    });
    const inserted = Array.isArray(row) ? row[0] : row;
    if(inserted) state.data.notes.unshift(inserted);
    document.getElementById("note_text").value = "";
    toast("Notat lagret");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke lagre notat", "error");
  }
}
async function deleteNote(id){
  try{
    await sb(`notes?id=eq.${id}`, { method:"DELETE", prefer:"return=minimal" });
    state.data.notes = state.data.notes.filter(n=>n.id!==id);
    toast("Notat slettet");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke slette notat", "error");
  }
}

/* ============================================================
 *  Actions ‚Äì Maintenance
 * ============================================================ */
async function addMaintenance(){
  const txt = document.getElementById("maint_text").value.trim();
  if(!txt) return toast("Skriv en oppgave f√∏rst", "warn");
  const maxP = state.data.maintenance.reduce((m,x)=>Math.max(m, x.priority||0), 0);
  try{
    const row = await sb("maintenance_tasks", {
      method:"POST",
      body:{
        text: txt,
        completed:false,
        priority: maxP+1,
        added_by: state.user.name,
        added_by_color: state.user.color
      }
    });
    const inserted = Array.isArray(row) ? row[0] : row;
    if(inserted) state.data.maintenance.push(inserted);
    document.getElementById("maint_text").value = "";
    toast("Vedlikehold lagt til");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke lagre vedlikehold", "error");
  }
}
async function toggleMaintenance(id, current){
  try{
    await sb(`maintenance_tasks?id=eq.${id}`, { method:"PATCH", body:{ completed: !current } });
    const idx = state.data.maintenance.findIndex(x=>x.id===id);
    if(idx>=0) state.data.maintenance[idx].completed = !current;
    toast(!current ? "Markert som ferdig" : "√Öpnet igjen");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke oppdatere", "error");
  }
}
async function deleteMaintenance(id){
  try{
    await sb(`maintenance_tasks?id=eq.${id}`, { method:"DELETE", prefer:"return=minimal" });
    state.data.maintenance = state.data.maintenance.filter(x=>x.id!==id);
    toast("Slettet");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke slette", "error");
  }
}

/* ============================================================
 *  Actions ‚Äì Calendar
 * ============================================================ */
async function addCalendar(){
  const title = document.getElementById("cal_title").value.trim();
  const date  = document.getElementById("cal_date").value;
  const time  = document.getElementById("cal_time").value;
  const dur   = parseInt(document.getElementById("cal_dur").value || "60", 10);
  const allDay= document.getElementById("cal_allday").checked;

  if(!title) return toast("Skriv inn tittel", "warn");
  if(!date) return toast("Velg dato", "warn");

  let start;
  if(allDay){
    // all-day: start 08:00 local
    start = new Date(`${date}T08:00:00`);
  } else {
    if(!time) return toast("Velg tidspunkt", "warn");
    start = new Date(`${date}T${time}:00`);
  }
  const startIso = start.toISOString();
  const endIso = new Date(start.getTime() + (isFinite(dur)?dur:60)*60000).toISOString();

  try{
    const row = await sb("calendar_events", {
      method:"POST",
      body:{
        title,
        start_time: startIso,
        end_time: endIso,
        duration: isFinite(dur)?dur:60,
        all_day: !!allDay,
        added_by: state.user.name,
        added_by_color: state.user.color
      }
    });
    const inserted = Array.isArray(row) ? row[0] : row;
    if(inserted){
      state.data.calendar.push(inserted);
      state.data.calendar.sort((a,b)=>new Date(a.start_time)-new Date(b.start_time));
    }
    document.getElementById("cal_title").value = "";
    toast("Hendelse lagt til");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke lagre kalenderhendelse", "error");
  }
}

async function deleteCalendar(id){
  try{
    await sb(`calendar_events?id=eq.${id}`, { method:"DELETE", prefer:"return=minimal" });
    state.data.calendar = state.data.calendar.filter(x=>x.id!==id);
    toast("Hendelse slettet");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke slette", "error");
  }
}

/* ============================================================
 *  Actions ‚Äì Allowance (Chores)
 * ============================================================ */
function calcStatsForChild(name){
  // Godkjente utbetalinger er worker rows med approved_at + earned_amount
  const approved = state.data.workers.filter(w => w.worker_name === name && w.approved_at);
  const sum = approved.reduce((acc,w)=>acc + (w.earned_amount||0), 0);
  const pending = state.data.workers.filter(w => w.worker_name === name && w.completed_at && !w.approved_at).length;
  return { approvedCount: approved.length, sum, pending };
}

function choreStatusLabel(s){
  const map = {
    available:"Tilgjengelig",
    in_progress:"P√•g√•r",
    completed:"Utf√∏rt (venter)",
    approved:"Godkjent",
    rejected:"Avvist"
  };
  return map[s] || s || "";
}

async function createChoreTask(){
  if(!isParent()) return toast("Bare foreldre kan opprette oppgaver", "warn");
  const title = document.getElementById("ch_title").value.trim();
  const amount = parseInt(document.getElementById("ch_amount").value || "0",10);
  const category = document.getElementById("ch_cat").value;
  if(!title) return toast("Skriv inn oppgavetittel", "warn");
  if(!isFinite(amount) || amount<=0) return toast("Skriv inn bel√∏p (kr)", "warn");

  try{
    const row = await sb("chore_tasks", {
      method:"POST",
      body:{
        title,
        description: null,
        amount,
        task_type: "once",
        category: category || "hjemme",
        status: "available",
        created_by: state.user.name,
        created_by_color: state.user.color,
        proposed_by_child: false,
        created_at: new Date().toISOString()
      }
    });
    const inserted = Array.isArray(row) ? row[0] : row;
    if(inserted) state.data.chores.unshift(inserted);
    document.getElementById("ch_title").value = "";
    document.getElementById("ch_amount").value = "";
    toast("Oppgave opprettet");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke opprette oppgave", "error");
  }
}

function getWorkerForTask(taskId){
  return state.data.workers.find(w => w.task_id === taskId);
}

async function takeTask(taskId){
  if(isParent()) return toast("Barn tar oppgaver üôÇ", "warn");
  const t = state.data.chores.find(x=>x.id===taskId);
  if(!t) return;
  if(t.status !== "available") return toast("Oppgaven er ikke tilgjengelig", "warn");

  try{
    // 1) lag worker rad
    const wr = await sb("chore_workers", {
      method:"POST",
      body:{
        task_id: taskId,
        worker_name: state.user.name,
        worker_color: state.user.color,
        percentage: 100,
        confirmed: true,
        earned_amount: null,
        started_at: new Date().toISOString()
      }
    });
    const insertedW = Array.isArray(wr) ? wr[0] : wr;
    if(insertedW) state.data.workers.unshift(insertedW);

    // 2) oppdater task status
    await sb(`chore_tasks?id=eq.${taskId}`, { method:"PATCH", body:{ status:"in_progress" } });
    t.status = "in_progress";

    toast("Oppgave tatt! üí™");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke ta oppgaven", "error");
  }
}

async function completeTask(taskId){
  if(isParent()) return toast("Barn markerer fullf√∏rt üôÇ", "warn");
  const t = state.data.chores.find(x=>x.id===taskId);
  if(!t) return;
  if(t.status !== "in_progress") return toast("Oppgaven m√• v√¶re 'p√•g√•r'", "warn");
  const w = getWorkerForTask(taskId);
  if(!w || w.worker_name !== state.user.name) return toast("Dette er ikke din oppgave", "warn");

  try{
    const now = new Date().toISOString();
    await sb(`chore_workers?id=eq.${w.id}`, { method:"PATCH", body:{ completed_at: now } });
    w.completed_at = now;

    await sb(`chore_tasks?id=eq.${taskId}`, { method:"PATCH", body:{ status:"completed" } });
    t.status = "completed";

    toast("Markert som fullf√∏rt ‚Äì venter p√• godkjenning");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke markere fullf√∏rt", "error");
  }
}

async function approveTask(taskId){
  if(!isParent()) return toast("Bare foreldre kan godkjenne", "warn");
  const t = state.data.chores.find(x=>x.id===taskId);
  if(!t) return;
  if(t.status !== "completed") return toast("Oppgaven m√• v√¶re 'utf√∏rt (venter)'", "warn");
  const w = getWorkerForTask(taskId);
  if(!w || !w.completed_at) return toast("Mangler worker/fullf√∏rt", "warn");

  try{
    const now = new Date().toISOString();
    // oppdater worker
    await sb(`chore_workers?id=eq.${w.id}`, {
      method:"PATCH",
      body:{
        approved_at: now,
        approved_by: state.user.name,
        earned_amount: t.amount
      }
    });
    w.approved_at = now;
    w.approved_by = state.user.name;
    w.earned_amount = t.amount;

    // oppdater task
    await sb(`chore_tasks?id=eq.${taskId}`, {
      method:"PATCH",
      body:{
        status:"approved",
        approved_at: now,
        approved_by: state.user.name
      }
    });
    t.status = "approved";
    t.approved_at = now;
    t.approved_by = state.user.name;

    toast("Godkjent ‚úÖ");
    render();
  } catch(e){
    console.error(e);
    toast("Kunne ikke godkjenne", "error");
  }
}

/* ============================================================
 *  Render
 * ============================================================ */
function tabBtn(id, label){
  const u = state.user;
  const active = state.tab === id;
  const style = active
    ? `background:${u.color}; border-color:${u.color};`
    : `border-color:${u.color}; color:${u.color};`;
  return `<button class="tab ${active?"active":""}" style="${style}" onclick="switchTab('${id}')">${label}</button>`;
}

function renderLogin(){
  appEl.innerHTML = `
    <div style="padding:20px; text-align:center">
      <div style="font-size:42px; margin-top:10px">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
      <h2 style="margin:10px 0 6px 0; font-weight:950">Familietid</h2>
      <div class="muted" style="margin-bottom:14px">Velg hvem du er</div>
      <div style="display:flex; flex-direction:column; gap:12px; max-width:460px; margin:0 auto">
        ${USERS.map(u=>`
          <button class="btn" style="background:#fff; border:3px solid ${u.color}; color:${u.color}; padding:16px; border-radius:18px"
                  onclick="selectUser('${escapeHtml(u.name)}')">
            <span style="font-size:20px">${u.emoji}</span>
            <span style="margin-left:10px; font-size:16px; font-weight:950">${escapeHtml(u.name)}</span>
            <span class="pill" style="margin-left:10px">${u.role==="parent"?"Forelder":"Barn"}</span>
          </button>
        `).join("")}
      </div>
      <div class="muted" style="margin-top:16px; font-size:12px">Kj√∏rer direkte fra Supabase ‚Äì deles av hele familien.</div>
    </div>
  `;
}

function renderHeader(){
  const u = state.user;
  const online = state.online ? `<span class="badge">üü¢ Online</span>` : `<span class="badge">üü† Offline?</span>`;
  return `
    <div class="top" style="background:linear-gradient(135deg, ${u.color} 0%, ${u.color}80 100%);">
      <div class="topL">
        <div class="emoji">${u.emoji}</div>
        <div>
          <div class="h1">Hei, ${escapeHtml(u.name)}!</div>
          <div class="sub">${online} <span style="margin-left:8px; opacity:.9">Familietid</span></div>
        </div>
      </div>
      <button class="btn ghost" onclick="logout()">Bytt bruker</button>
    </div>
  `;
}

function renderTabs(){
  return `
    <div class="tabs">
      ${tabBtn("shopping","üõí Handleliste")}
      ${tabBtn("calendar","üìÖ Kalender")}
      ${tabBtn("notes","üìù Notater")}
      ${tabBtn("maintenance","üîß Vedlikehold")}
      ${tabBtn("allowance","üí∞ Ukel√∏nn")}
    </div>
  `;
}

function renderShopping(){
  const loading = state.loading.shopping ? `<span class="pill">Laster‚Ä¶</span>` : "";
  const items = state.data.shopping;
  return `
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0; font-weight:950">üõí Handleliste</h3>
        <div>${loading}</div>
      </div>

      <div class="sep"></div>

      <div class="row" style="align-items:center">
        <input id="shop_text" class="field" style="flex:2" placeholder="Hva skal vi handle? (Enter)"
               onkeypress="if(event.key==='Enter'){ addShopping(); }">
        <input id="shop_qty" class="field" style="flex:0.6; max-width:120px" type="number" min="1" value="1" />
        <button class="btn primary" onclick="addShopping()">Legg til</button>
        <button class="btn" style="background:#11182710; color:#111827" onclick="loadShopping()">Oppdater</button>
      </div>

      <div class="list">
        ${items.length===0 ? `
          <div class="item" style="border-left-color:${state.user.color}">
            <div>
              <div class="title">Handlelisten er tom</div>
              <div class="meta">Legg til f√∏rste vare over üëÜ</div>
            </div>
          </div>
        ` : items.map(it=>{
          const left = it.added_by_color || state.user.color;
          const checked = !!it.checked;
          return `
            <div class="item" style="border-left-color:${left}">
              <div style="flex:1">
                <div class="title" style="${checked?"text-decoration:line-through; color:#9ca3af":""}">
                  ${escapeHtml(it.text)} ${it.quantity>1?`<span class="pill">${it.quantity}x</span>`:""}
                </div>
                <div class="meta">
                  <span style="color:${left}; font-weight:950">${escapeHtml(it.added_by||"")}</span>
                  ¬∑ ${fmtAgo(it.timestamp)}
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center">
                <button class="btn small" style="background:${left}; color:#fff"
                        onclick="toggleShopping(${it.id}, ${checked})">${checked?"‚úÖ":"‚óªÔ∏è"}</button>
                <button class="btn small danger" onclick="deleteShopping(${it.id})">Slett</button>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

function renderNotes(){
  const loading = state.loading.notes ? `<span class="pill">Laster‚Ä¶</span>` : "";
  const notes = state.data.notes;
  return `
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0; font-weight:950">üìù Notater</h3>
        <div>${loading}</div>
      </div>

      <div class="sep"></div>

      <textarea id="note_text" class="field" style="min-height:110px" placeholder="Skriv et notat‚Ä¶"></textarea>
      <div class="row" style="margin-top:10px; align-items:center">
        <button class="btn primary" onclick="addNote()">Lagre notat</button>
        <button class="btn" style="background:#11182710; color:#111827" onclick="loadNotes()">Oppdater</button>
      </div>

      <div class="list">
        ${notes.length===0 ? `
          <div class="item" style="border-left-color:${state.user.color}">
            <div>
              <div class="title">Ingen notater enda</div>
              <div class="meta">Legg inn et notat over üëÜ</div>
            </div>
          </div>
        ` : notes.map(n=>{
          const left = n.added_by_color || state.user.color;
          return `
            <div class="item" style="border-left-color:${left}">
              <div style="flex:1">
                <div class="title" style="font-weight:850">${escapeHtml(n.text)}</div>
                <div class="meta">
                  <span style="color:${left}; font-weight:950">${escapeHtml(n.added_by||"")}</span>
                  ¬∑ ${fmtAgo(n.timestamp)}
                </div>
              </div>
              <button class="btn small danger" onclick="deleteNote(${n.id})">Slett</button>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

function renderMaintenance(){
  const loading = state.loading.maintenance ? `<span class="pill">Laster‚Ä¶</span>` : "";
  const tasks = state.data.maintenance;
  return `
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0; font-weight:950">üîß Vedlikehold</h3>
        <div>${loading}</div>
      </div>

      <div class="sep"></div>

      <div class="row" style="align-items:center">
        <input id="maint_text" class="field" style="flex:2" placeholder="Ny vedlikeholdsoppgave (Enter)"
               onkeypress="if(event.key==='Enter'){ addMaintenance(); }">
        <button class="btn primary" onclick="addMaintenance()">Legg til</button>
        <button class="btn" style="background:#11182710; color:#111827" onclick="loadMaintenance()">Oppdater</button>
      </div>

      <div class="list">
        ${tasks.length===0 ? `
          <div class="item" style="border-left-color:${state.user.color}">
            <div>
              <div class="title">Ingen vedlikeholdsoppgaver</div>
              <div class="meta">Legg til noe over üëÜ</div>
            </div>
          </div>
        ` : tasks.map(t=>{
          const left = t.added_by_color || state.user.color;
          const done = !!t.completed;
          return `
            <div class="item" style="border-left-color:${left}; opacity:${done?0.75:1}">
              <div style="flex:1">
                <div class="title" style="${done?"text-decoration:line-through; color:#9ca3af":""}">
                  ${escapeHtml(t.text)}
                  <span class="pill">prio ${t.priority ?? ""}</span>
                </div>
                <div class="meta">
                  <span style="color:${left}; font-weight:950">${escapeHtml(t.added_by||"")}</span>
                  ${t.timestamp?`¬∑ ${fmtAgo(t.timestamp)}`:""}
                </div>
              </div>
              <div style="display:flex; gap:8px">
                <button class="btn small" style="background:${left}; color:#fff"
                        onclick="toggleMaintenance(${t.id}, ${done})">${done?"‚Ü©Ô∏è":"‚úÖ"}</button>
                <button class="btn small danger" onclick="deleteMaintenance(${t.id})">Slett</button>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

function renderCalendar(){
  const loading = state.loading.calendar ? `<span class="pill">Laster‚Ä¶</span>` : "";
  const evs = state.data.calendar;

  const today = new Date();
  const todayKey = today.toISOString().slice(0,10);
  const todays = evs.filter(e => (e.start_time||"").slice(0,10) === todayKey);

  return `
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0; font-weight:950">üìÖ Kalender</h3>
        <div>${loading}</div>
      </div>

      <div class="sep"></div>

      <div class="grid2" style="align-items:start">
        <div>
          <div class="badge" style="margin-bottom:10px">Legg til hendelse</div>
          <input id="cal_title" class="field" placeholder="Tittel (f.eks. Fotballtrening)">
          <div class="row" style="margin-top:10px">
            <input id="cal_date" class="field" type="date" value="${todayKey}">
            <input id="cal_time" class="field" type="time" value="18:00">
          </div>
          <div class="row" style="margin-top:10px; align-items:center">
            <input id="cal_dur" class="field" type="number" min="15" step="15" value="60" style="max-width:140px">
            <label class="badge" style="background:#11182708">
              <input id="cal_allday" type="checkbox" style="transform:scale(1.2); margin-right:8px"> Heldag
            </label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" onclick="addCalendar()">Legg til</button>
            <button class="btn" style="background:#11182710; color:#111827" onclick="loadCalendar()">Oppdater</button>
          </div>
          <div class="muted" style="margin-top:8px; font-size:12px">
            Tips: Heldag = starter 08:00. Varighet brukes for sluttid.
          </div>
        </div>

        <div>
          <div class="badge" style="margin-bottom:10px">I dag</div>
          ${todays.length===0 ? `<div class="muted">Ingen hendelser i dag.</div>` : `
            <div class="list">
              ${todays.map(e=>{
                const left = e.added_by_color || state.user.color;
                return `
                  <div class="item" style="border-left-color:${left}">
                    <div style="flex:1">
                      <div class="title">${escapeHtml(e.title)}</div>
                      <div class="meta">
                        <span style="color:${left}; font-weight:950">${escapeHtml(e.added_by||"")}</span>
                        ¬∑ ${fmtTimeOnly(e.start_time)}‚Äì${e.end_time?fmtTimeOnly(e.end_time):""}
                      </div>
                    </div>
                    <button class="btn small danger" onclick="deleteCalendar(${e.id})">Slett</button>
                  </div>
                `;
              }).join("")}
            </div>
          `}
        </div>
      </div>

      <div class="sep"></div>

      <div class="badge" style="margin-bottom:10px">Kommende</div>
      <div class="list">
        ${evs.length===0 ? `
          <div class="item" style="border-left-color:${state.user.color}">
            <div>
              <div class="title">Ingen kalenderhendelser</div>
              <div class="meta">Legg til en hendelse over üëÜ</div>
            </div>
          </div>
        ` : evs.slice(0,25).map(e=>{
          const left = e.added_by_color || state.user.color;
          return `
            <div class="item" style="border-left-color:${left}">
              <div style="flex:1">
                <div class="title">${escapeHtml(e.title)}</div>
                <div class="meta">
                  <span style="color:${left}; font-weight:950">${escapeHtml(e.added_by||"")}</span>
                  ¬∑ ${fmtDateOnly(e.start_time)} ${fmtTimeOnly(e.start_time)}
                </div>
              </div>
              <button class="btn small danger" onclick="deleteCalendar(${e.id})">Slett</button>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

function renderAllowance(){
  const loading = state.loading.allowance ? `<span class="pill">Laster‚Ä¶</span>` : "";
  const chores = state.data.chores;
  const workers = state.data.workers;

  const childStats = USERS.filter(u=>u.role==="child").map(u=>{
    const s = calcStatsForChild(u.name);
    return { ...u, ...s };
  });

  const available = chores.filter(c=>c.status==="available");
  const inprog = chores.filter(c=>c.status==="in_progress");
  const completed = chores.filter(c=>c.status==="completed");
  const approved = chores.filter(c=>c.status==="approved");

  function renderTaskCard(t){
    const left = t.created_by_color || "#11182755";
    const w = workers.find(x=>x.task_id===t.id);
    const assignee = w ? `${w.worker_name}` : "";
    const status = choreStatusLabel(t.status);
    const canTake = (!isParent() && t.status==="available");
    const canComplete = (!isParent() && t.status==="in_progress" && w && w.worker_name===state.user.name);
    const canApprove = (isParent() && t.status==="completed");

    return `
      <div class="item" style="border-left-color:${left}">
        <div style="flex:1">
          <div class="title">${escapeHtml(t.title)} <span class="pill">${t.amount} kr</span></div>
          <div class="meta">
            <span style="color:${left}; font-weight:950">${escapeHtml(t.created_by||"")}</span>
            ¬∑ ${escapeHtml(status)}
            ${assignee ? `¬∑ <span style="font-weight:950; color:${w.worker_color||"#111827"}">${escapeHtml(assignee)}</span>` : ""}
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
          ${canTake ? `<button class="btn small ok" onclick="takeTask(${t.id})">Ta</button>` : ""}
          ${canComplete ? `<button class="btn small" style="background:${state.user.color}; color:#fff" onclick="completeTask(${t.id})">Fullf√∏r</button>` : ""}
          ${canApprove ? `<button class="btn small ok" onclick="approveTask(${t.id})">Godkjenn</button>` : ""}
        </div>
      </div>
    `;
  }

  return `
    <div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <h3 style="margin:0; font-weight:950">üí∞ Ukel√∏nn</h3>
        <div>${loading}</div>
      </div>

      <div class="sep"></div>

      <div class="grid2">
        <div>
          <div class="badge" style="margin-bottom:10px">Statistikk (godkjent)</div>
          <div class="list">
            ${childStats.map(s=>`
              <div class="item" style="border-left-color:${s.color}">
                <div style="flex:1">
                  <div class="title">${s.emoji} ${escapeHtml(s.name)}</div>
                  <div class="meta">Godkjente: <b>${s.approvedCount}</b> ¬∑ Sum: <b>${s.sum} kr</b> ¬∑ Venter: <b>${s.pending}</b></div>
                </div>
              </div>
            `).join("")}
          </div>
          <div class="muted" style="font-size:12px; margin-top:8px">
            ‚ÄúSum‚Äù √∏ker n√•r forelder trykker ‚ÄúGodkjenn‚Äù.
          </div>
        </div>

        <div>
          <div class="badge" style="margin-bottom:10px">Opprett oppgave</div>
          ${isParent() ? `
            <input id="ch_title" class="field" placeholder="Oppgavetittel (f.eks. Vaske badet)">
            <div class="row" style="margin-top:10px">
              <input id="ch_amount" class="field" type="number" min="1" step="5" placeholder="Bel√∏p (kr)">
              <select id="ch_cat" class="field">
                <option value="hjemme">Hjemme</option>
                <option value="ute">Ute</option>
                <option value="annet">Annet</option>
              </select>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" onclick="createChoreTask()">Opprett</button>
              <button class="btn" style="background:#11182710; color:#111827" onclick="loadAllowance()">Oppdater</button>
            </div>
          ` : `
            <div class="muted">Foreldre kan opprette oppgaver her.</div>
            <div class="row" style="margin-top:10px">
              <button class="btn" style="background:#11182710; color:#111827" onclick="loadAllowance()">Oppdater</button>
            </div>
          `}
        </div>
      </div>

      <div class="sep"></div>

      <div class="badge" style="margin-bottom:10px">Tilgjengelige oppgaver</div>
      <div class="list">
        ${available.length===0 ? `<div class="muted">Ingen tilgjengelige oppgaver akkurat n√•.</div>` : available.map(renderTaskCard).join("")}
      </div>

      <div class="sep"></div>

      <div class="badge" style="margin-bottom:10px">P√•g√•r</div>
      <div class="list">
        ${inprog.length===0 ? `<div class="muted">Ingen oppgaver p√•g√•r.</div>` : inprog.map(renderTaskCard).join("")}
      </div>

      <div class="sep"></div>

      <div class="badge" style="margin-bottom:10px">Utf√∏rt (venter godkjenning)</div>
      <div class="list">
        ${completed.length===0 ? `<div class="muted">Ingen oppgaver venter p√• godkjenning.</div>` : completed.map(renderTaskCard).join("")}
      </div>

      <div class="sep"></div>

      <div class="badge" style="margin-bottom:10px">Godkjent</div>
      <div class="list">
        ${approved.length===0 ? `<div class="muted">Ingen oppgaver er godkjent enn√•.</div>` : approved.slice(0,12).map(renderTaskCard).join("")}
      </div>
    </div>
  `;
}

function render(){
  if(!state.user) return renderLogin();

  appEl.innerHTML = `
    ${renderHeader()}
    <div class="content">
      ${renderTabs()}
      <div class="card" style="padding:16px; border-radius:18px; box-shadow:none; background:#ffffffaa">
        ${
          state.tab==="shopping" ? renderShopping() :
          state.tab==="calendar" ? renderCalendar() :
          state.tab==="notes" ? renderNotes() :
          state.tab==="maintenance" ? renderMaintenance() :
          renderAllowance()
        }
      </div>

      <div class="muted" style="text-align:center; margin-top:14px; font-size:12px">
        Familietid ¬∑ statisk p√• Vercel ¬∑ data i Supabase ¬∑ <span style="font-weight:900">Ingen eksterne biblioteker</span>
      </div>
    </div>
  `;
}

/* ============================================================
 *  App flow
 * ============================================================ */
function selectUser(name){
  const u = USERS.find(x=>x.name===name);
  if(!u) return;
  state.user = u;
  localStorage.setItem(LS_KEY, name);
  toast(`Velkommen, ${u.name}!`);
  // last tabens data f√∏rst (rask f√∏lelse av respons)
  switchTab(state.tab, true);
}

function logout(){
  state.user = null;
  localStorage.removeItem(LS_KEY);
  state.tab = "shopping";
  toast("Byttet bruker", "success");
  render();
}

function switchTab(tab, silent=false){
  state.tab = tab;
  render();

  // last data for valgt fane (hvis ikke lastet)
  if(tab==="shopping") loadShopping();
  if(tab==="calendar") loadCalendar();
  if(tab==="notes") loadNotes();
  if(tab==="maintenance") loadMaintenance();
  if(tab==="allowance") loadAllowance();

  if(!silent) hideToast();
}

/* ============================================================
 *  Expose functions to window (for onclick handlers)
 * ============================================================ */
window.selectUser = selectUser;
window.logout = logout;
window.switchTab = switchTab;

window.addShopping = addShopping;
window.toggleShopping = toggleShopping;
window.deleteShopping = deleteShopping;

window.addNote = addNote;
window.deleteNote = deleteNote;

window.addMaintenance = addMaintenance;
window.toggleMaintenance = toggleMaintenance;
window.deleteMaintenance = deleteMaintenance;

window.addCalendar = addCalendar;
window.deleteCalendar = deleteCalendar;

window.createChoreTask = createChoreTask;
window.takeTask = takeTask;
window.completeTask = completeTask;
window.approveTask = approveTask;

/* ============================================================
 *  Init
 * ============================================================ */
(function init(){
  // render UI med en gang
  render();

  // auto-login hvis valgt f√∏r
  const saved = localStorage.getItem(LS_KEY);
  if(saved && USERS.some(u=>u.name===saved)){
    selectUser(saved);
  }

  // pr√∏v √• sjekke ‚Äúonline‚Äù i bakgrunn
  (async()=>{
    try{
      // lett ping: hent 1 rad fra shopping (eller tom)
      await sb("shopping_items", { query:{ select:"id", limit:"1" } });
      setOnlineFlag(true);
    }catch(e){
      setOnlineFlag(false);
    }finally{
      render();
    }
  })();
})();
</script>
</body>
</html>
